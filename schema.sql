CREATE TABLE public.treats (
    sku text NOT NULL,
    name text NOT NULL,
    satiety integer NOT NULL DEFAULT 0,
    price integer NOT NULL DEFAULT 0,
    CONSTRAINT treats_pkey PRIMARY KEY (sku),
    CONSTRAINT treats_name_key UNIQUE (name),
    CONSTRAINT treats_sku_key UNIQUE (sku)
) tablespace pg_default;


CREATE TABLE public.evolution_stages (
    stage smallint NOT NULL,
    max_happiness smallint NOT NULL,
    max_hunger smallint NOT NULL,
    CONSTRAINT evolution_stages_pkey PRIMARY KEY (stage)
) tablespace pg_default;


CREATE TABLE public.creature_types (
    type text NOT NULL,
    fav_treat text NOT NULL,
    hated_treat text NOT NULL,
    CONSTRAINT creature_types_pkey PRIMARY KEY (type),
    CONSTRAINT creature_types_type_key UNIQUE (type),
    CONSTRAINT creature_types_fav_treat_fkey FOREIGN KEY (fav_treat) REFERENCES treats (sku),
    CONSTRAINT creature_types_hated_treat_fkey FOREIGN KEY (hated_treat) REFERENCES treats (sku)
) tablespace pg_default;


CREATE TABLE public.creatures (
    id bigint generated by DEFAULT AS identity NOT NULL,
    name text NOT NULL,
    type text NOT NULL,
    happiness integer NOT NULL DEFAULT 100,
    hunger integer NOT NULL DEFAULT 100,
    stage smallint NOT NULL DEFAULT '1' :: smallint,
    CONSTRAINT creatures_pkey PRIMARY KEY (id),
    CONSTRAINT creatures_name_key UNIQUE (name),
    CONSTRAINT creatures_stage_fkey FOREIGN KEY (stage) REFERENCES evolution_stages (stage),
    CONSTRAINT creatures_type_fkey FOREIGN KEY (type) REFERENCES creature_types (TYPE)
) tablespace pg_default;


CREATE TABLE public.users (
    id uuid NOT NULL,
    username text NOT NULL,
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_username_key UNIQUE (username),
    CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON UPDATE CASCADE
) tablespace pg_default;


CREATE TABLE public.user_gold (
    id bigint generated by DEFAULT AS identity NOT NULL,
    user_id uuid NOT NULL DEFAULT auth.uid (),
    amount integer NOT NULL,
    time_created timestamp WITH time zone NOT NULL DEFAULT (NOW() at time zone 'utc' :: text),
    CONSTRAINT user_gold_pkey PRIMARY KEY (id),
    CONSTRAINT user_gold_user_id_fkey FOREIGN KEY (user_id) REFERENCES users (id) ON UPDATE CASCADE ON DELETE CASCADE
) tablespace pg_default;


CREATE VIEW public.gold_view AS
SELECT
    u.id AS user_id,
    coalesce(sum(g.amount), 0 :: bigint) AS gold
FROM
    users u
    LEFT JOIN user_gold g ON g.user_id = u.id
GROUP BY
    u.id;


CREATE TABLE public.users_inventory (
    id bigint generated by DEFAULT AS identity NOT NULL,
    user_id uuid NOT NULL DEFAULT auth.uid (),
    treat_sku text NOT NULL,
    quantity integer NOT NULL,
    CONSTRAINT users_inventory_pkey PRIMARY KEY (id),
    CONSTRAINT users_inventory_treat_sku_fkey1 FOREIGN KEY (treat_sku) REFERENCES treats (sku) ON UPDATE CASCADE,
    CONSTRAINT users_inventory_user_id_fkey FOREIGN KEY (user_id) REFERENCES users (id) ON UPDATE CASCADE ON DELETE CASCADE
) tablespace pg_default;


CREATE VIEW public.user_inventory_view AS
SELECT
    i.user_id,
    i.treat_sku,
    coalesce(sum(i.quantity), '0' :: bigint) AS quantity
FROM
    users_inventory i
GROUP BY
    i.user_id,
    i.treat_sku;


CREATE TABLE public.user_creature_connection (
    user_id uuid NOT NULL DEFAULT auth.uid (),
    creature_id bigint NOT NULL,
    affinity integer NOT NULL DEFAULT 0,
    is_adopted boolean NOT NULL DEFAULT false,
    CONSTRAINT user_creature_connection_pkey PRIMARY KEY (user_id, creature_id),
    CONSTRAINT user_creature_connection_creature_id_fkey FOREIGN KEY (creature_id) REFERENCES creatures (id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT user_creature_connection_user_id_fkey FOREIGN KEY (user_id) REFERENCES users (id) ON UPDATE CASCADE ON DELETE CASCADE
) tablespace pg_default;


CREATE TABLE public.purchases (
    order_id bigint NOT NULL,
    completed_at timestamp WITH time zone NOT NULL DEFAULT (NOW() at time zone 'utc' :: text),
    user_id uuid NOT NULL DEFAULT auth.uid (),
    item_sku text NOT NULL DEFAULT '' :: text,
    quantity bigint NOT NULL DEFAULT '0' :: bigint,
    CONSTRAINT purchases_pkey PRIMARY KEY (order_id),
    CONSTRAINT purchases_item_sku_fkey FOREIGN KEY (item_sku) REFERENCES treats (sku) ON UPDATE CASCADE,
    CONSTRAINT purchases_user_id_fkey FOREIGN KEY (user_id) REFERENCES users (id) ON UPDATE CASCADE ON DELETE CASCADE
) tablespace pg_default;


INSERT INTO treats (sku, name, satiety, price)
VALUES
    ('CLOUD_CANDY', 'cloud candy', 15, 15),
    ('CRUMBLY_COOKIE', 'crumbly cookie', 20, 20),
    ('CUCUMBER_SALAD', 'cucumber salad', 30, 30),
    ('GOGI_BERRY', 'gogi berry', 10, 10),
    ('HONEY', 'honey', 8, 8),
    ('KEBAB', 'kebab', 75, 75),
    ('NABNAB_BERRY', 'nabnab berry', 15, 15),
    ('PINAP_BERRY', 'pinap berry', 20, 20),
    ('RAZZ_BERRY', 'razz berry', 10, 10),
    ('SARDINE', 'sardine', 45, 45),
    ('SEAWEED_SNACK', 'seaweed', 25, 25),
    ('SHADOW_BREAD', 'shadow bread', 42, 42),
    ('SHINY_BERRY', 'shiny berry', 27, 27),
    ('SPICE_COOKIE', 'spice cookie', 38, 38),
    ('STEAK_SKEWER', 'steak skewer', 95, 95),
    ('TAIYAKI', 'taiyaki', 55, 55),
    ('VANILLA_FLUFF', 'vanilla fluff', 22, 22)
ON CONFLICT DO NOTHING;

INSERT INTO
    evolution_stages (stage, max_happiness, max_hunger)
VALUES
    (1, 100, 100),
    (2, 500, 500),
    (3, 1000, 1000)
ON CONFLICT DO NOTHING;

INSERT INTO
    creature_types (type, fav_treat, hated_treat)
VALUES
    ('water_turtle', 'SARDINE', 'KEBAB'),
    ('fire_lizard', 'SPICE_COOKIE', 'SEAWEED_SNACK'),
    ('grass_dragon', 'CUCUMBER_SALAD', 'SPICE_COOKIE'),
    ('sea_ghost', 'SHADOW_BREAD', 'CRUMBLY_COOKIE'),
    ('psychic_unicorn', 'SHINY_BERRY', 'SHADOW_BREAD'),
    ('fighter_cow', 'GOGI_BERRY', 'STEAK_SKEWER'),
    ('silly_cat', 'TAIYAKI', 'CUCUMBER_SALAD'),
    ('electric_sheep', 'CLOUD_CANDY', 'SARDINE'),
    ('fluffy_fairy', 'PINAP_BERRY', 'VANILLA_FLUFF'),
    ('flying_bug', 'VANILLA_FLUFF', 'HONEY')
ON CONFLICT DO NOTHING;

INSERT INTO
    creatures (id, name, type, happiness, hunger)
VALUES
    (1, 'Aquaquel', 'water_turtle', 100, 0),
    (2, 'Blaze', 'fire_lizard', 100, 0),
    (3, 'Whiskaroo', 'silly_cat', 100, 0),
    (4, 'Rumbull', 'fighter_cow', 100, 0),
    (5, 'Spectrip', 'sea_ghost', 100, 0),
    (6, 'Mindara', 'psychic_unicorn', 100, 0),
    (7, 'Zap E. Wool', 'electric_sheep', 100, 0),
    (8, 'Flutterbop', 'flying_bug', 100, 0),
    (9, 'Puffilia', 'fluffy_fairy', 100, 0),
    (10, 'Thornvyne', 'grass_dragon', 100, 0),
    (11, 'Shellwater', 'water_turtle', 100, 0),
    (12, 'Infernyx', 'fire_lizard', 100, 0),
    (13, 'Nibbly', 'silly_cat', 100, 0),
    (14, 'Brawlow', 'fighter_cow', 100, 0),
    (15, 'Haunter Glow', 'sea_ghost', 100, 0),
    (16, 'Mystara', 'psychic_unicorn', 100, 0),
    (17, 'Shocuff', 'electric_sheep', 100, 0),
    (18, 'Flyka', 'flying_bug', 100, 0),
    (19, 'Fayblossom', 'fluffy_fairy', 100, 0),
    (20, 'Grumblevine', 'grass_dragon', 100, 0)
ON CONFLICT DO NOTHING;